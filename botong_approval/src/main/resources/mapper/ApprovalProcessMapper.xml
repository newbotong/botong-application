<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yunjing.approval.dao.mapper.ApprovalProcessMapper">

    <resultMap id="ApprovalMap" type="com.yunjing.approval.model.dto.ApprovalContentVO">
        <result column="approval_id" property="approvalId"/>
        <result column="model_id" property="modelId"/>
        <result column="model_name" property="modelName"/>
        <result column="state" property="state"/>
        <result column="create_time" property="createTime"/>
        <result column="user_id" property="userId"/>
        <result column="reason" property="message"/>
    </resultMap>
    <select id="getWaitedMeApprovalList" resultMap="ApprovalMap">
      SELECT ap.id, ap.approval_id, ap.user_id, ap.state, ap.seq, ap.process_time, ap.reason, a.model_id, a.create_time,m.model_name
      FROM approval_process ap
      JOIN approval a ON ap.approval_id = a.id
      JOIN model m  ON m.id = a.model_id
      <where>
          ap. approval_id = a.id AND ap.state = 0
          <if test="userId != null and userId != ''">
              and ap.user_id = #{userId}
          </if>
          <if test="orgId != null and orgId != ''">
              and a.org_id = #{orgId}
          </if>
          <if test="searchKey != null and searchKey != '' and flag == true">
              and (DATE_FORMAT(a.create_time, '%Y-%m-%d') = #{searchKey} )
          </if>
      </where>
      ORDER BY ap.process_time DESC
      limit #{index},#{size}
    </select>
</mapper>